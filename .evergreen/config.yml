########################################
# Evergreen Template for MongoDB Drivers
########################################

# When a task that used to pass starts to fail
# Go through all versions that may have been skipped to detect
# when the task started failing
stepback: true

# Mark a failure as a system/bootstrap failure (purple box) rather then a task
# failure by default.
# Actual testing tasks are marked with `type: test`
command_type: system

# Protect ourselves against rogue test case, or curl gone wild, that runs forever
# Good rule of thumb: the average-ish length a task takes, times 5.
# That roughly accounts for variable system performance for various build variants.
exec_timeout_secs: 3600   # 1 hour is the longest we'll ever run

# What to do when evergreen hits the timeout (`post:` tasks are run automatically)
timeout:
  - command: shell.exec
    params:
      script: |
        ls -la

functions:
  "install astrolabe":
    # Executes git clone and applies the submitted patch, if any
    - command: git.get_project
      params:
        directory: astrolabe-src
    - command: shell.exec
      params:
        working_dir: astrolabe-src
        script: |
          export ASTROLABE_SRC_DIRECTORY="$(pwd)"
          export ASTROLABE_VIRTUALENV_NAME="astrolabevenv"
          export ASTROLABE_BINARY="$ASTROLABE_SRC_DIRECTORY/$ASTROLABE_VIRTUALENV_NAME/bin/astrolabe"
          cat <<EOT > astrolabe-expansion.yml
          PREPARE_SHELL_COMMON: |
            set -o errexit
            export ASTROLABE_PY3_BINARY="${SYSTEM_PYTHON3_BINARY}"
            export ASTROLABE_VIRTUALENV_NAME="$ASTROLABE_VIRTUALENV_NAME"
            export ASTROLABE_BINARY="$ASTROLABE_BINARY"
            export ATLAS_PROJECT_NAME="${project}"
            export EVERGREEN_BUILD_ID="{build_id}"
            export ATLAS_API_USERNAME="${atlas_key}"
            export ATLAS_API_PASSWORD="${atlas_secret}"
            export TARGET_DRIVER_REPOSITORY="${DRIVER_REPOSITORY}"
            export TARGET_DRIVER_REVISION="${DRIVER_REVISION}"
            export TARGET_DRIVER_SCRIPTS_DIRECTORY="$(pwd)/.evergreen/${DRIVER_DIRNAME}"
          EOT
          # Don't print this as it contains credentials.
    - command: expansions.update
      params:
        file: astrolabe-src/astrolabe-expansion.yml
    - command: shell.exec
      params:
        working_dir: astrolabe-src
        script: |
          ${PREPARE_SHELL_COMMON}
          sh .evergreen/install-astrolabe.sh

  "clone target driver":
    - command: shell.exec
      params:
        script: |
          ${PREPARE_SHELL_COMMON}
          git clone --recursive --branch "$TARGET_DRIVER_REVISION" "$TARGET_DRIVER_REPOSITORY" driver-src

  "make files executable":
    - command: shell.exec
      params:
        script: |
          ${PREPARE_SHELL_COMMON}
          for i in $(find "$TARGET_DRIVER_SCRIPTS_DIRECTORY" -name \*.sh); do
            chmod +x $i
          done

  "setup driver":
    - command: shell.exec
      params:
        working_dir: driver-src
        script: |
          ${PREPARE_SHELL_COMMON}
          ${PREPARE_SHELL_DRIVER}
          sh "$TARGET_DRIVER_SCRIPTS_DIRECTORY"/setup-driver.sh

  "run tests":
    - command: shell.exec
      type: test
      params:
        working_dir:
        script: |
          ${PREPARE_SHELL_COMMON}
          ${PREPARE_SHELL_DRIVER}
          "$ASTROLABE_BINARY" --log-level debug spec-tests run astrolabe-src/temp-tests -e "$TARGET_DRIVER_SCRIPTS_DIRECTORY"/workload-executor.sh --group-name testproject --cluster-name-salt somesalt

  "upload test results":
    - command: attach.xunit_results
      params:
        file: "xunit-output/*.xml"

  "ls":
    - command: shell.exec
      params:
        script: |
          ls -la
    - command: shell.exec
      params:
        working_dir: astrolabe-src
        script: |
          ls -la
    - command: shell.exec
      params:
        working_dir: driver-src
        script: |
          ls -la

  "prepare shell pymongo":
    - command: shell.exec
      params:
        working_dir: driver-src
        script: |
          cat <<EOT > pymongo-expansion.yml
          PREPARE_SHELL_DRIVER: |
            set -o errexit
            export PYTHON_BINARY="${PYTHON_BINARY}"
          EOT
          # See what we've done
          cat pymongo-expansion.yml
    - command: expansions.update
      params:
        file: driver-src/pymongo-expansion.yml

pre:
  - func: "install astrolabe"
  - func: "make files executable"
  - func: "clone target driver"

post:
  - func: "upload test results"
  - func: "ls"

tasks:
    - name: "Python-Driver"
      tags: ["pymongo"]
      commands:
        - func: "prepare shell pymongo"
        - func: "setup driver"
        - func: "run tests"

axes:
  # Choice of driver
  - id: driver
    display_name: driver-language
    values:
      - id: python36
        display_name: pymongo-py36
        variables:
          PYTHON_BINARY: "/opt/python/3.6/bin/python3"
          DRIVER_REPOSITORY: &pymongo_url "https://github.com/mongodb/mongo-python-driver.git"
          DRIVER_REVISION: &master "master"
          DRIVER_DIRNAME: "python"
      - id: python37
        display_name: pymongo-py37
        variables:
          PYTHON_BINARY: "/opt/python/3.7/bin/python3"
          DRIVER_REPOSITORY: *pymongo_url
          DRIVER_REVISION: *master
          DRIVER_DIRNAME: "python"
      - id: python38
        display_name: pymongo-py38
        variables:
          PYTHON_BINARY: "/opt/python/3.8/bin/python3"
          DRIVER_REPOSITORY: *pymongo_url
          DRIVER_REVISION: *master
          DRIVER_DIRNAME: "python"

  # Choice of distro
  - id: platform
    display_name: OS
    values:
      - id: ubuntu-16.04
        display_name: "Ubuntu 16.04"
        run_on: ubuntu1604-test
        batchtime: 10080  # 7 days
        variables:
          SYSTEM_PYTHON3_BINARY: "/opt/python/3.7/bin/python3"

buildvariants:
- matrix_name: "tests-python"
  matrix_spec:
    platform: "*"
    driver: ["python36", "python37", "python38"]
  display_name: "${driver} ${platform}"
  tasks:
    - ".pymongo"
